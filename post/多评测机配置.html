<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta content="IE=edge" http-equiv="X-UA-Compatible">
	<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" name="viewport">
	<title>多评测机配置 - UOJ部署指北</title>

	<!-- css -->
	<link href="/css/base.min.css" rel="stylesheet">
	<link href="/css/project.min.css" rel="stylesheet">
	<link href="/css/styles.css" rel="stylesheet">
	<link href="https://unpkg.com/gitalk/dist/gitalk.css" rel="stylesheet">

</head>
<body class="page-brand">
	
	<header class="header header-transparent header-waterfall ui-header">
		<ul class="nav nav-list pull-left">
			<li>
				<a data-toggle="menu" href="#menu">
					<span class="icon icon-lg">menu</span>
				</a>
			</li>
		</ul>
		<a class="header-logo header-affix-hide margin-left-no margin-right-no" data-offset-top="213" data-spy="affix">多评测机配置</a>
		<span class="header-logo header-affix margin-left-no margin-right-no" data-offset-top="213" data-spy="affix">多评测机配置</span>

		<ul class="nav nav-list pull-right">
			<li>
				<a data-toggle="menu" href="/">
					<span class="avatar avatar-sm"><img alt="logo" src="/img/logo.png"></span>
				</a>
			</li>
		</ul>

	</header>

	<nav aria-hidden="true" class="menu" id="menu" tabindex="-1">
		<div class="menu-scroll">
			<div class="menu-content">
				<a class="menu-logo" href="/">UOJ部署指北</a>
				<ul class="nav">
					<li>
					
						
							
							
								<a class="collapsed waves-attach waves-effect" data-toggle="collapse" href="#入门">入门</a>	
								<ul class="menu-collapse collapse in" id="入门">

								<li>
									<a class="waves-attach" href="/post/安装.html">安装</a>
								</li><li>
									<a class="waves-attach" href="/post/维护.html">维护</a>
								</li><li>
									<a class="waves-attach" href="/post/外网映射教程.html">外网映射教程</a>
								</li><li>
									<a class="waves-attach" href="/post/系统管理.html">系统管理</a>
								</li><li class="active">
									<a class="waves-attach" href="/post/多评测机配置.html">多评测机配置</a>
								</li></ul>
								<a class="collapsed waves-attach waves-effect" data-toggle="collapse" href="#题目">题目</a>	
								<ul class="menu-collapse collapse in" id="题目">

								<li>
									<a class="waves-attach" href="/post/题目管理概述.html">题目管理概述</a>
								</li><li>
									<a class="waves-attach" href="/post/传统题配置.html">传统题配置</a>
								</li><li>
									<a class="waves-attach" href="/post/特殊需求配置.html">特殊需求配置</a>
								</li><li>
									<a class="waves-attach" href="/post/数据检验器.html">数据检验器</a>
								</li><li>
									<a class="waves-attach" href="/post/答案检查器.html">答案检查器</a>
								</li></ul>
								<a class="collapsed waves-attach waves-effect" data-toggle="collapse" href="#开发">开发</a>	
								<ul class="menu-collapse collapse in" id="开发">

								<li>
									<a class="waves-attach" href="/post/SVN简易指北.html">SVN简易指北</a>
								</li><li>
									<a class="waves-attach" href="/post/本地构建镜像.html">本地构建镜像</a>
								</li><li>
									<a class="waves-attach" href="/post/贡献.html">贡献</a>
								</li></ul>
								<a class="collapsed waves-attach waves-effect" data-toggle="collapse" href="#关于">关于</a>	
								<ul class="menu-collapse collapse in" id="关于">

								<li>
									<a class="waves-attach" href="/post/关于.html">关于</a>
								</li></ul>						


					</li>
					
				</ul>
			</div>
		</div>
	</nav>
	<main class="content">
		<div class="content-header ui-content-header">
			<div class="container">
				<tit class="content-heading">多评测机配置</tit>
			</div>
		</div>
		<div class="container">
			<section class="content-inner margin-top-no">
				<div class="row">
					<div class="col-lg-13 col-md-13">
						<div class="card margin-bottom-no">
							<div class="card-main">
								<div class="card-inner page-card-inner">
						<blockquote class="note">
<p>这篇文档将指导您为 UOJ 社区版添加多个评测机。</p>
<p>在安装之前，请确保您已经通过安装了新版的 UOJ 社区版；在下文中，我们称该容器为 UOJ 容器。 </p>
</blockquote>
<h2>在原 UOJ 容器所在物理机上安装</h2>
<h3>使用自动构建的镜像（推荐）</h3>
<p>首先，请进入 UOJ 容器，并记录 <code>/opt/uoj/judger/.conf.json</code> 的内容。</p>
<p>执行下面的命令，从 DockerHub 中获取评测机镜像：</p>
<div class="codehilite"><pre><span></span>sudo docker pull universaloj/uoj-system:judger
</pre></div>


<p>请新建文件 <code>judger_env.list</code>，请根据下文说明替换下面的文件内容：</p>
<div class="codehilite"><pre><span></span>UOJ_PROTOCOL=http
UOJ_HOST=&lt;uoj_host&gt;
JUDGER_NAME=&lt;judger_name&gt;
JUDGER_PASSWORD=&lt;judger_pwd&gt;
SOCKET_PORT=2333
SOCKET_PASSWORD=&lt;socket_pwd&gt;
</pre></div>


<p>您需要替换：</p>
<ul>
<li><code>&lt;judger_name&gt;</code>：新评测机的名称，不应与之前的评测机重复，仅可由小写字母和数字组成。</li>
<li><code>&lt;uoj_host&gt;</code>：UOJ 容器的<strong>容器 IP</strong>。</li>
<li>可通过 <code>docker inspect --format '{{ .NetworkSettings.IPAddress }}' &lt;container_id&gt;</code> 来获得名为 <code>&lt;container_id&gt;</code> 的容器的 IP</li>
<li><code>&lt;judger_pwd&gt;</code>：评测机密码，可以不修改。</li>
<li><code>&lt;socket_pwd&gt;</code>：通讯密码，应与您在第一步中从 UOJ 容器中获得的密码相同。</li>
</ul>
<p>接下来，在 <code>judger_env.list</code> 所在目录下，执行下面的命令来启动评测机。其中，请将 <code>&lt;judger_name&gt;</code> 替换为评测机的名称。</p>
<div class="codehilite"><pre><span></span>sudo docker run --name &lt;judger_name&gt; -dit --env-file judger_env.list --cap-add SYS_PTRACE universaloj/uoj-system:judger
</pre></div>


<p>启动后，请您查看新启动的评测容器的 IP 并记录下来。之后，您应该进入 UOJ 容器中的 mysql 中的 <code>app_uoj233</code> 数据库， 并将新的评测机的信息用以下命令加入数据库（请不要在网页端后台操作添加）：</p>
<div class="codehilite"><pre><span></span><span class="k">insert</span> <span class="k">into</span> <span class="n">judger_info</span> <span class="p">(</span><span class="n">judger_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;&lt;judger_name&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;judger_pwd&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;judger_ip&gt;&#39;</span><span class="p">);</span>
</pre></div>


<p>最后，退出 mysql 和 docker。</p>
<p>此时，如果配置正确，您应该可以在网页端看到新的评测机了。您可以通过同时提交数个死循环程序，来检查多个评测机是否工作正常。</p>
<p><strong>注意：对于每道题，您需要在新评测机配置完成后点击题目管理页面中的“检查配置并同步数据”来将数据同步到每台评测机。</strong></p>
<h3>使用 Dockerfile 手动构建</h3>
<p>首先，您需要查看 UOJ 容器的 judger 配置并按照其配置配置新的评测机。请先在终端中进入一个临时文件夹，用于存放临时文件。之后，您需要从 UOJ 容器中复制出<code>/opt/uoj/judger/.conf.json</code>：</p>
<div class="codehilite"><pre><span></span>docker cp uoj:/opt/uoj/judger/.conf.json ./conf.json
</pre></div>


<p>然后，请您编辑复制出的 <code>conf.json</code>，修改：</p>
<ul>
<li><code>uoj_host</code>：UOJ 容器的<strong>容器IP</strong>（某容器的IP可通过命令<code>docker inspect --format '{{ .NetworkSettings.IPAddress }}' &lt;container-id&gt;</code>来获取） 。</li>
<li><code>jugder_name</code>：新评测机的名称，不应与之前的评测机重复，仅可由小写字母和数字组成。</li>
<li><code>judger_password</code>：密码，可以不修改。</li>
</ul>
<p>下一步，您需要通过 Dockerfile 构建新 judger 的镜像。</p>
<p>新建一个名为 <code>Dockerfile</code> 的文件，其内容如下：</p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span> <span class="s">ubuntu:18.04</span>
<span class="k">MAINTAINER</span><span class="s"> MascoSkray &lt;MascoSkray@gmail.com&gt;</span>
<span class="k">ARG</span> CLONE_ADDFLAG

<span class="k">WORKDIR</span><span class="s"> /opt</span>
<span class="c">#Update apt and install git</span>
<span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y git
<span class="c">#Clone the latest UOJ Community verison to local</span>
<span class="k">RUN</span> git clone https://github.com/UniversalOJ/UOJ-System.git --depth <span class="m">1</span> --single-branch <span class="si">${</span><span class="nv">CLONE_ADDFLAG</span><span class="si">}</span> uoj
<span class="c">#Install environment and set startup script</span>
<span class="k">COPY</span> conf.json /opt/uoj/judger/.conf.json
<span class="k">RUN</span> <span class="nb">cd</span> uoj/install/judger <span class="o">&amp;&amp;</span> sh install.sh -p <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;\</span>
<span class="s2">#!/bin/sh\n\</span>
<span class="s2">if [ ! -f \&quot;/opt/uoj/judger/.conf.json\&quot; ]; then\n\</span>
<span class="s2">  cd /opt/uoj/install/judger &amp;&amp; sh install.sh -i\n\</span>
<span class="s2">fi\n\</span>
<span class="s2">service ntp start\n\</span>
<span class="s2">su judger -c \&quot;/opt/uoj/judger/judge_client start\&quot;\n\</span>
<span class="s2">exec bash\n&quot;</span> &gt;/opt/up <span class="o">&amp;&amp;</span> chmod +x /opt/up

<span class="k">ENV</span> <span class="nv">LANG</span><span class="o">=</span>C.UTF-8 <span class="nv">TZ</span><span class="o">=</span>Asia/Shanghai
<span class="k">EXPOSE</span><span class="s"> 2333</span>
<span class="k">CMD</span> /opt/up
</pre></div>


<p>该 Dockerfile 相对于原始文件，仅增加了将我们修改过的 <code>conf.json</code> 复制到容器的相应位置的代码。在某些国家，由于某些限制，可能导致 clone 过程执行过慢，您可以考虑将仓库手动克隆到您所在国家的代码托管网站。</p>
<p>使用如下命令构建该镜像：</p>
<div class="codehilite"><pre><span></span>docker build -f Dockerfile .
</pre></div>


<p>在经历漫长的等待后，如果构建过程正常，您将可以看到：</p>
<div class="codehilite"><pre><span></span>Successfully built &lt;image-id&gt;
</pre></div>


<p>请记录下 <code>&lt;image-id&gt;</code> 。</p>
<p>然后，您需要使用刚才构建的镜像启动一个新的评测容器：</p>
<div class="codehilite"><pre><span></span>docker run -dit --name &lt;judger-name&gt; --cap-add SYS_PTRACE &lt;image-id&gt;
</pre></div>


<p>启动后，请您查看新启动的评测容器的 IP 并记录下来。之后，您应该进入 UOJ 容器中的 mysql 中的 <code>app_uoj233</code>， 并将新的评测机的信息加入数据库（请不要在网页端后台操作添加）：</p>
<div class="codehilite"><pre><span></span><span class="k">insert</span> <span class="k">into</span> <span class="n">judger_info</span> <span class="p">(</span><span class="n">judger_name</span><span class="p">,</span> <span class="k">password</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;&lt;judger_name&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;judger_password&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;judger_ip&gt;&#39;</span><span class="p">);</span>
</pre></div>


<p>退出 mysql ，按组合键  <code>Ctrl+P+Q</code> 离开并不停止容器。</p>
<p>此时，如果配置正确，您应该可以在网页端看到新的评测机了。</p>
<p><strong>注意：对于每道题，您需要在新评测机配置完成后点击题目管理页面中的“检查配置并同步数据”来将数据同步到每台评测机。</strong></p>
<p>如果需要安装更多评测机，不需要重新构建镜像。请直接使用刚才的命令从之前的镜像启动一个新的 judger 容器。然后，进入这个新的 judger 容器，并编辑 <code>/opt/uoj/judger/.conf.json</code> 为新 judger 的信息。之后，保存文件、退出容器并重启该容器。然后按照第四步的方式将新的评测机加入数据库。</p>
<h2>不在原 UOJ 容器所在物理机上安装</h2>
<blockquote class="note">
<p>我们将 UOJ 容器所在的服务器称作主服务器。</p>
</blockquote>
<p><em>建议主机与评测机在同一内网下，否则数据同步将消耗大量的网络资源。</em></p>
<p>在此情况下，大体按照前面的方式进行安装，并进行以下修改：</p>
<ul>
<li><code>uoj_host</code> 修改为主服务器的物理机内网 IP 。</li>
<li>启动新评测机的命令中添加：<code>-p 2333:2333</code> 。</li>
<li>将评测机加入数据库时填写的 IP 为新评测机容器的物理机内网 IP 。</li>
</ul>
								<hr>

								<!-- Gitalk 评论框 start -->
								<div id="gitalk-container"></div>
								<!-- Gitalk 评论框 end -->

								</div>
							</div>
						</div>
					</section>
				</div>
			</div>

			
			<hr>
			<center>[CC协议 BY-NC-SA] 署名 - 非商业性使用 - 相同方式共享  @ UOJ部署指北 2018</center>

		</div>


	</main>
	
	<div class="fbtn-container">
		<div class="fbtn-inner">
			<a class="fbtn fbtn-lg fbtn-brand-accent waves-attach waves-circle waves-light" data-toggle="dropdown">
				<span class="fbtn-text fbtn-text-left">Home</span>
				<span class="fbtn-ori icon">apps</span>
				<span class="fbtn-sub icon">close</span>
			</a>
			<div class="fbtn-dropup">
				<a class="fbtn waves-attach waves-circle" href="https://github.com/UniversalOJ/UniversalOJ.github.io/issues" target="_blank">
					<span class="fbtn-text fbtn-text-left">反馈</span><span class="icon">feedback</span>
				</a>
				<a class="fbtn fbtn-green waves-attach waves-circle" href="/" target="_self">
					<span class="fbtn-text fbtn-text-left">返回主页</span><span class="icon">home</span>
				</a>
			</div>
		</div>
	</div>

	

	<!-- js -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/base.min.js"></script>
    
    <!-- Gitalk JS 代码 start -->
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
      proxy: 'https://cors.pion1eer.workers.dev/?https://github.com/login/oauth/access_token',
      clientID: '0dc093a9aefa1d501df2',
      clientSecret: '3639aabd1bc6b0d9b543be1f13b6bcb2bf7364af',
      repo: 'UniversalOJ.github.io',
	  id: location.pathname,
      owner: 'UniversalOJ',
      admin: ['cebarobot', 'MascoSkray', 'Ruanxingzhi', 'billchenchina'],
      labels: [],
    })
    
    gitalk.render('gitalk-container')
    </script>
    <!-- Gitalk JS 代码 end -->
    
</body>
</html>
